name: CI/CD Template

on:
  workflow_call:
    inputs:
      environment:
        description: 'dev/prod'
        required: true
        type: string

env:
  IMAGE_TAG: ${{ inputs.environment == 'prod' && github.ref_name || github.sha }}
  EC2_HOST: ${{ inputs.environment == 'prod' && secrets.EC2_HOST_PROD || secrets.EC2_HOST_DEV }}
  EC2_SSH_KEY: ${{ inputs.environment == 'prod' && secrets.EC2_SSH_KEY_PROD || secrets.EC2_SSH_KEY_DEV }}
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  DOCKER_REPO: ${{ secrets.DOCKER_REPO }}
  DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}

jobs:
  build-and-release:
    name: Build and Release for ${{ inputs.environment }}
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: 'temurin'

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          cache-from: type=gha
          cache-to: type=gha,mode=max
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/${{ secrets.DOCKER_REPO }}:${{ env.IMAGE_TAG }}
            ${{ inputs.environment == 'prod' && format('{0}/{1}:latest', secrets.DOCKER_USERNAME, secrets.DOCKER_REPO) || '' }}
          platforms: linux/amd64

  deploy:
    needs: build-and-release
    runs-on: ubuntu-24.04
    name: Deploy for ${{ inputs.environment }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure directory permissions
        uses: appleboy/ssh-action@master
        with:
          host: ${{ env.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ env.EC2_SSH_KEY }}
          port: 22
          script: |
            sudo mkdir -p /opt/focus-to-level-up
            sudo chown -R $USER:$USER /opt/focus-to-level-up

      - name: Copy docker-compose file to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ env.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ env.EC2_SSH_KEY }}
          port: 22
          source: docker-compose-${{ inputs.environment }}.yml
          target: /opt/focus-to-level-up

      - name: Copy deploy script to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ env.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ env.EC2_SSH_KEY }}
          port: 22
          source: scripts/deploy.sh
          target: /opt/focus-to-level-up

      - name: Copy DB init scripts to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ env.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ env.EC2_SSH_KEY }}
          port: 22
          source: src/main/resources/db/
          target: /opt/focus-to-level-up
          strip_components: 0

      - name: Rename docker-compose file on EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ env.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ env.EC2_SSH_KEY }}
          port: 22
          script: |
            mv /opt/focus-to-level-up/docker-compose-${{ inputs.environment }}.yml /opt/focus-to-level-up/docker-compose.yml

      - name: Deploy to EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ env.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ env.EC2_SSH_KEY }}
          envs: IMAGE_TAG,DOCKER_USERNAME,DOCKER_REPO,DOCKER_PASSWORD
          port: 22
          script: |
            set -e
                    
            # .env 파일 생성
            cat > /opt/focus-to-level-up/.env << 'ENV_EOF'
            ${{ inputs.environment == 'prod' && secrets.ENV_FILE_PROD || secrets.ENV_FILE_DEV }}
            ENV_EOF
            
            # 쉘 환경 변수 설정
            export IMAGE_TAG="${IMAGE_TAG}"
            export DOCKER_USERNAME="${DOCKER_USERNAME}"
            export DOCKER_REPO="${DOCKER_REPO}"
            
            # Docker 로그인
            echo "${DOCKER_PASSWORD}" | docker login -u "${DOCKER_USERNAME}" --password-stdin
            
            # DB 및 공통 서비스 확인
            if [ "${{ inputs.environment }}" != "prod" ]; then
               docker compose -f /opt/focus-to-level-up/docker-compose.yml up -d mysql redis
               sleep 15
            fi
            
            # docker compose -f /opt/focus-to-level-up/docker-compose.yml pull app
            # docker compose -f /opt/focus-to-level-up/docker-compose.yml up -d

            # Extract DB credentials from .env file
            DB_ROOT_PASSWORD=$(grep '^DB_ROOT_PASSWORD=' /opt/focus-to-level-up/.env | cut -d '=' -f2)
            DB_USERNAME=$(grep '^DB_USERNAME=' /opt/focus-to-level-up/.env | cut -d '=' -f2)
            DB_PASSWORD=$(grep '^DB_PASSWORD=' /opt/focus-to-level-up/.env | cut -d '=' -f2)

            if [ "${{ inputs.environment }}" = "prod" ]; then
              # Prod: RDS에 focus_meta_db 생성 (master 유저로 접속하므로 GRANT 불필요)
              echo "Initializing RDS database..."

              which mysql || (sudo apt-get update && sudo apt-get install -y mysql-client)

              DB_URL=$(grep '^DB_URL=' /opt/focus-to-level-up/.env | cut -d '=' -f2)
              DB_HOST=$(echo $DB_URL | sed -n 's|.*://\([^:/]*\).*|\1|p')

              mysql -h ${DB_HOST} -u ${DB_USERNAME} -p${DB_PASSWORD} -e "CREATE DATABASE IF NOT EXISTS focus_meta_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;" || true

            else
              # Dev: Docker MySQL 컨테이너 사용 (root로 접속하여 권한 부여)
              echo "Waiting for MySQL container to be ready..."
              sleep 10

              docker exec focus-mysql mysql -uroot -p${DB_ROOT_PASSWORD} -e "CREATE DATABASE IF NOT EXISTS focus_meta_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;" || true
              docker exec focus-mysql mysql -uroot -p${DB_ROOT_PASSWORD} -e "GRANT ALL PRIVILEGES ON focus_meta_db.* TO '${DB_USERNAME}'@'%';" || true
              docker exec focus-mysql mysql -uroot -p${DB_ROOT_PASSWORD} -e "FLUSH PRIVILEGES;" || true
            fi
            
            # 6. 배포 스크립트 실행 권한 부여 및 실행
            echo "Executing Blue-Green Deployment Script..."
            chmod +x /opt/focus-to-level-up/scripts/deploy.sh
            
            # deploy.sh 실행
            /opt/focus-to-level-up/scripts/deploy.sh

            docker image prune -f
